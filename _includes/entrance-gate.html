<!-- ç½‘ç«™å…¥å£å¤§é—¨æ•ˆæœ -->
<div id="entrance-gate" class="entrance-gate">
  <div class="gate-content">
    <h1 class="gate-title">æ¬¢è¿æ¥åˆ°Nagisaçš„ä¸–ç•Œ</h1>
    <div class="gate-subtitle">ç‚¹å‡»ä»»æ„ä½ç½®è¿›å…¥</div>
    <div class="gate-click-hint">âœ¨</div>
  </div>
  <div class="gate-overlay"></div>
</div>

<script>
(function() {
  console.log('ğŸšª å…¥å£å¤§é—¨è„šæœ¬å¼€å§‹æ‰§è¡Œ');

  /* æ£€æŸ¥æ˜¯å¦åœ¨åŒä¸€æµè§ˆå™¨ä¼šè¯ä¸­å·²è®¿é—®è¿‡ */
  var hasVisited = sessionStorage.getItem('hasVisited');

  if (hasVisited) {
    /* å¦‚æœå·²è®¿é—®è¿‡ï¼Œç›´æ¥éšè—å…¥å£é¡µé¢ */
    console.log('ğŸ‘‹ å·²è®¿é—®è¿‡ï¼Œéšè—å…¥å£å¤§é—¨');
    var gate = document.getElementById('entrance-gate');
    if (gate) {
      gate.style.display = 'none';
    }
    return;
  }

  console.log('ğŸ†• é¦–æ¬¡è®¿é—®ï¼Œæ˜¾ç¤ºå…¥å£å¤§é—¨');

  /* é¦–æ¬¡è®¿é—®æ—¶ï¼Œéšè—é¡µé¢å†…å®¹å¹¶æ˜¾ç¤ºå¤§é—¨ */
  document.body.classList.add('page-hidden');

  var gate = document.getElementById('entrance-gate');

  if (!gate) {
    console.error('âŒ æ‰¾ä¸åˆ°å…¥å£å¤§é—¨å…ƒç´ ï¼Œç›´æ¥æ˜¾ç¤ºé¡µé¢');
    /* å¦‚æœæ‰¾ä¸åˆ°å¤§é—¨å…ƒç´ ï¼Œç«‹å³æ˜¾ç¤ºé¡µé¢å†…å®¹ */
    document.body.classList.remove('page-hidden');
    return;
  }

  console.log('âœ… æ‰¾åˆ°å…¥å£å¤§é—¨å…ƒç´ ');

  /* æ˜¾ç¤ºå…¥å£å¤§é—¨æ—¶ç¦ç”¨é¡µé¢æ»šåŠ¨ */
  document.body.classList.add('gate-active');

  /* å®‰å…¨æœºåˆ¶ï¼š10ç§’åå¦‚æœç”¨æˆ·è¿˜æ²¡ç‚¹å‡»ï¼Œè‡ªåŠ¨æ˜¾ç¤ºé¡µé¢ */
  var safetyTimeout = setTimeout(function() {
    console.log('âš ï¸ å®‰å…¨è¶…æ—¶ï¼šè‡ªåŠ¨æ˜¾ç¤ºé¡µé¢');
    gate.classList.add('fade-out');
    setTimeout(function() {
      showPage();
    }, 400);
  }, 10000);

  /* æ˜¾ç¤ºé¡µé¢çš„å‡½æ•° */
  function showPage() {
    sessionStorage.setItem('hasVisited', 'true');
    document.body.classList.remove('gate-active');
    document.body.classList.remove('page-hidden');
    document.body.classList.add('page-show');
    console.log('âœ¨ é¡µé¢å†…å®¹å¼€å§‹æ¸å…¥æ˜¾ç¤º');

    /* å¤§é—¨ä¼šç»§ç»­æ¸éšï¼Œç­‰å®Œå…¨æ¶ˆå¤±åå†éšè— */
    setTimeout(function() {
      gate.style.display = 'none';
    }, 600);

    /* æ¸å…¥åŠ¨ç”»å®Œæˆåç§»é™¤åŠ¨ç”»class */
    setTimeout(function() {
      document.body.classList.remove('page-show');
      console.log('âœ… é¡µé¢å®Œå…¨æ˜¾ç¤º');
    }, 1500); /* ä¸CSSåŠ¨ç”»æ—¶é•¿ä¸€è‡´ */
  }

  /* æ–°çš„æµè§ˆå™¨ä¼šè¯ï¼Œé‡ç½®éŸ³ä¹æ’­æ”¾çŠ¶æ€ */
  /* æ¸…é™¤æ‰€æœ‰éŸ³ä¹ç›¸å…³çš„ localStorageï¼Œè®©æ’­æ”¾å™¨åŠ è½½é»˜è®¤æ­Œæ›² */
  localStorage.removeItem('musicCurrentTrack');
  localStorage.removeItem('musicCurrentTime');
  localStorage.removeItem('musicWasPlaying');
  localStorage.removeItem('musicPlaylistLength');
  console.log('ğŸ”„ æµè§ˆå™¨é‡å¯ï¼ŒéŸ³ä¹çŠ¶æ€å·²é‡ç½®');

  /* ç‚¹å‡»åæ¸éšè¿›å…¥ç½‘ç«™å¹¶å¯åŠ¨éŸ³ä¹ */
  gate.addEventListener('click', function(e) {
    /* æ¸…é™¤å®‰å…¨è¶…æ—¶ */
    clearTimeout(safetyTimeout);
    console.log('ğŸ–±ï¸ å…¥å£å¤§é—¨è¢«ç‚¹å‡»ï¼', e.target);
    gate.classList.add('fade-out');

    /* å¯åŠ¨éŸ³ä¹æ’­æ”¾ï¼ˆåˆ©ç”¨ç”¨æˆ·äº¤äº’ç»•è¿‡æµè§ˆå™¨çš„è‡ªåŠ¨æ’­æ”¾é™åˆ¶ï¼‰ */
    var audio = document.getElementById('audio-player');
    var playBtn = document.getElementById('play-btn');

    /* å°è¯•å¤šæ¬¡å¯åŠ¨æ’­æ”¾ï¼Œç¡®ä¿æˆåŠŸ */
    function tryPlayMusic(attempts, delay) {
      if (attempts <= 0) {
        console.log('éŸ³ä¹æ’­æ”¾å¯åŠ¨å¤±è´¥ï¼Œå·²å°è¯•å¤šæ¬¡');
        return;
      }

      /* æ£€æŸ¥éŸ³é¢‘æ˜¯å¦çœŸæ­£åŠ è½½äº†æœ‰æ•ˆçš„æº */
      var hasValidSrc = audio && audio.src && audio.src !== '' && audio.src !== window.location.href;

      if (hasValidSrc && playBtn) {
        /* æ£€æŸ¥éŸ³é¢‘æ˜¯å¦å‡†å¤‡å¥½å¯ä»¥æ’­æ”¾ */
        if (audio.readyState >= 2) {
          if (audio.paused) {
            audio.play().then(function() {
              playBtn.textContent = 'â¸';
              console.log('éŸ³ä¹å·²å¼€å§‹æ’­æ”¾');
              /* ä¿å­˜æ’­æ”¾çŠ¶æ€ï¼Œä¾›é¡µé¢åˆ‡æ¢æ—¶æ¢å¤ */
              localStorage.setItem('musicWasPlaying', 'true');
            }).catch(function(error) {
              console.log('æ’­æ”¾å°è¯•å¤±è´¥ï¼Œå‰©ä½™å°è¯•æ¬¡æ•°ï¼š' + (attempts - 1), error);
              /* å¦‚æœå¤±è´¥ï¼Œå»¶è¿Ÿåé‡è¯•ï¼Œä½¿ç”¨é€’å¢å»¶è¿Ÿ */
              setTimeout(function() { tryPlayMusic(attempts - 1, Math.min(delay * 1.5, 1000)); }, delay);
            });
          } else {
            console.log('éŸ³ä¹å·²åœ¨æ’­æ”¾ä¸­');
          }
        } else {
          /* éŸ³é¢‘è¿˜åœ¨åŠ è½½ä¸­ï¼Œç­‰å¾… */
          console.log('éŸ³é¢‘æ­£åœ¨åŠ è½½ä¸­ (readyState: ' + audio.readyState + ')ï¼Œç­‰å¾…ä¸­...');
          setTimeout(function() { tryPlayMusic(attempts - 1, Math.min(delay * 1.5, 1000)); }, delay);
        }
      } else {
        /* éŸ³é¢‘è¿˜æœªå‡†å¤‡å¥½ï¼Œå»¶è¿Ÿåé‡è¯• */
        console.log('éŸ³é¢‘æœªå‡†å¤‡å¥½ï¼Œå»¶è¿Ÿé‡è¯•ï¼Œå‰©ä½™å°è¯•æ¬¡æ•°ï¼š' + (attempts - 1));
        setTimeout(function() { tryPlayMusic(attempts - 1, Math.min(delay * 1.5, 1000)); }, delay);
      }
    }

    /* å¼€å§‹å°è¯•æ’­æ”¾ï¼ˆæœ€å¤š10æ¬¡ï¼Œåˆå§‹å»¶è¿Ÿ150msï¼Œé€æ¸é€’å¢ï¼‰ */
    setTimeout(function() { tryPlayMusic(10, 150); }, 100);

    /* 0.4ç§’åå¼€å§‹é¡µé¢æ¸å…¥ï¼Œä¸å¤§é—¨æ¸éšå½¢æˆäº¤å‰æ•ˆæœ */
    setTimeout(function() {
      console.log('ğŸŒŸ å¼€å§‹é¡µé¢æ¸å…¥åŠ¨ç”»ï¼ˆå¤§é—¨ä»åœ¨æ¸éšï¼‰');
      showPage();
    }, 400); /* åœ¨å¤§é—¨æ¸éšåˆ°40%æ—¶å¼€å§‹é¡µé¢æ¸å…¥ */
  });

  /* æ·»åŠ é¼ æ ‡æ‚¬åœæ•ˆæœ */
  gate.addEventListener('mouseenter', function() {
    gate.classList.add('hover');
  });

  gate.addEventListener('mouseleave', function() {
    gate.classList.remove('hover');
  });
})();
</script>
