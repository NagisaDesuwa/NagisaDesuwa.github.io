<!-- å¯æ‹–åŠ¨çš„éŸ³ä¹æ’­æ”¾å™¨ -->
<div id="music-player" class="music-player">
  <div class="player-header" id="player-drag-handle">
    <span class="player-title">ğŸµ éŸ³ä¹æ’­æ”¾å™¨</span>
    <button class="player-toggle" id="player-toggle">âˆ’</button>
  </div>
  <div class="player-content" id="player-content">
    <div class="player-info">
      <div class="song-title" id="song-title">æœªé€‰æ‹©éŸ³ä¹</div>
      <div class="song-artist" id="song-artist"></div>
    </div>
    <audio id="audio-player" preload="metadata"></audio>
    <div class="player-controls">
      <button class="control-btn" id="prev-btn">â®</button>
      <button class="control-btn play-btn" id="play-btn">â–¶</button>
      <button class="control-btn" id="next-btn">â­</button>
      <button class="control-btn" id="mode-btn" title="æ’­æ”¾æ¨¡å¼">ğŸ”</button>
      <button class="control-btn" id="playlist-btn" title="æ’­æ”¾åˆ—è¡¨">ğŸ“‹</button>
    </div>
    <div class="progress-container">
      <span class="time" id="current-time">0:00</span>
      <input type="range" class="progress-bar" id="progress-bar" min="0" max="100" value="0">
      <span class="time" id="duration">0:00</span>
    </div>
    <div class="volume-container">
      <span>ğŸ”Š</span>
      <input type="range" class="volume-bar" id="volume-bar" min="0" max="100" value="30">
    </div>
    <div class="playlist-panel" id="playlist-panel">
      <div class="playlist-header">
        <span>æ’­æ”¾åˆ—è¡¨</span>
        <button class="playlist-close" id="playlist-close">âœ•</button>
      </div>
      <div class="playlist-items" id="playlist-items">
        <!-- æ’­æ”¾åˆ—è¡¨é¡¹å°†åŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  // æ’­æ”¾æ¨¡å¼: 'order' (é¡ºåº), 'random' (éšæœº), 'single' (å•æ›²å¾ªç¯)
  let playMode = 'order';
  let playlist = [];
  let currentTrack = 0;
  let shuffledIndices = []; // éšæœºæ’­æ”¾çš„ç´¢å¼•æ•°ç»„
  const player = document.getElementById('music-player');
  const audio = document.getElementById('audio-player');
  const playBtn = document.getElementById('play-btn');
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');
  const modeBtn = document.getElementById('mode-btn');
  const playlistBtn = document.getElementById('playlist-btn');
  const progressBar = document.getElementById('progress-bar');
  const volumeBar = document.getElementById('volume-bar');
  const currentTimeEl = document.getElementById('current-time');
  const durationEl = document.getElementById('duration');
  const songTitle = document.getElementById('song-title');
  const songArtist = document.getElementById('song-artist');
  const playerToggle = document.getElementById('player-toggle');
  const playerContent = document.getElementById('player-content');
  const playlistPanel = document.getElementById('playlist-panel');
  const playlistItems = document.getElementById('playlist-items');
  const playlistClose = document.getElementById('playlist-close');

  // ä»æ–‡ä»¶è·¯å¾„æå–æ­Œæ›²ä¿¡æ¯
  function extractSongInfo(path) {
    // è·å–æ–‡ä»¶åï¼ˆä¸å«è·¯å¾„å’Œæ‰©å±•åï¼‰
    const filename = path.split('/').pop().replace(/\.[^/.]+$/, '');

    // å°è¯•è§£æ "è‰ºæœ¯å®¶ - æ­Œæ›²å" æ ¼å¼
    let title = filename;
    let artist = '';

    if (filename.includes(' - ')) {
      const parts = filename.split(' - ');
      artist = parts[0].trim();
      title = parts.slice(1).join(' - ').trim();
    }

    // æ¸…ç†ç‰¹æ®Šå­—ç¬¦ï¼ˆå¦‚ ï¼»602ï½ï¼½ æˆ– [xxx]ï¼‰
    title = title.replace(/ï¼»[^\ï¼½]*ï¼½/g, '').replace(/\[[^\]]*\]/g, '').trim();
    artist = artist.replace(/ï¼»[^\ï¼½]*ï¼½/g, '').replace(/\[[^\]]*\]/g, '').trim();

    return { title: title || 'æœªçŸ¥æ­Œæ›²', artist };
  }

  // ä½¿ç”¨ Jekyll è‡ªåŠ¨æ‰«æ audio ç›®å½•ä¸‹çš„éŸ³é¢‘æ–‡ä»¶
  {% assign audio_files = site.static_files | where_exp: "file", "file.path contains '/audio/'" %}
  const audioFiles = [
    {% for file in audio_files %}
      {% assign ext = file.extname | downcase %}
      {% if ext == '.mp3' or ext == '.wav' or ext == '.ogg' or ext == '.m4a' or ext == '.flac' or ext == '.aac' %}
    "{{ file.path }}"{% unless forloop.last %},{% endunless %}
      {% endif %}
    {% endfor %}
  ];

  // åŠ è½½æ’­æ”¾åˆ—è¡¨
  function loadPlaylist() {
    // å°†æ–‡ä»¶è·¯å¾„è½¬æ¢ä¸ºæ’­æ”¾åˆ—è¡¨æ ¼å¼
    playlist = audioFiles.map(path => {
      const info = extractSongInfo(path);
      return {
        title: info.title,
        artist: info.artist,
        url: path
      };
    });

    if (playlist.length === 0) {
      songTitle.textContent = 'audio ç›®å½•ä¸‹æ²¡æœ‰éŸ³ä¹æ–‡ä»¶';
      playBtn.disabled = true;
      prevBtn.disabled = true;
      nextBtn.disabled = true;
      modeBtn.disabled = true;
      playlistBtn.disabled = true;
    } else {
      initializePlayer();
    }
  }

  // ç”Ÿæˆéšæœºæ’­æ”¾ç´¢å¼•
  function generateShuffledIndices() {
    shuffledIndices = Array.from({ length: playlist.length }, (_, i) => i);
    for (let i = shuffledIndices.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffledIndices[i], shuffledIndices[j]] = [shuffledIndices[j], shuffledIndices[i]];
    }
  }

  // è·å–å®é™…æ’­æ”¾ç´¢å¼•ï¼ˆè€ƒè™‘æ’­æ”¾æ¨¡å¼ï¼‰
  function getActualIndex(displayIndex) {
    if (playMode === 'random') {
      return shuffledIndices[displayIndex];
    }
    return displayIndex;
  }

  // æ¸²æŸ“æ’­æ”¾åˆ—è¡¨
  function renderPlaylist() {
    playlistItems.innerHTML = '';
    playlist.forEach((track, index) => {
      const item = document.createElement('div');
      item.className = 'playlist-item';
      if (getActualIndex(currentTrack) === index || (playMode !== 'random' && currentTrack === index)) {
        item.classList.add('active');
      }
      item.innerHTML = `
        <div class="playlist-item-title">${track.title}</div>
        <div class="playlist-item-artist">${track.artist || ''}</div>
      `;
      item.addEventListener('click', () => {
        // æ‰¾åˆ°è¿™ä¸ªç´¢å¼•åœ¨å½“å‰æ’­æ”¾æ¨¡å¼ä¸‹çš„ä½ç½®
        if (playMode === 'random') {
          currentTrack = shuffledIndices.indexOf(index);
        } else {
          currentTrack = index;
        }
        loadTrack(currentTrack);
        audio.play();
        playBtn.textContent = 'â¸';
        renderPlaylist();
        savePlayState();
      });
      playlistItems.appendChild(item);
    });
  }

  // åŠ è½½æ­Œæ›²
  function loadTrack(index) {
    if (playlist.length === 0) return;
    currentTrack = index;
    const actualIndex = getActualIndex(currentTrack);
    const track = playlist[actualIndex];
    audio.src = track.url;
    songTitle.textContent = track.title;
    songArtist.textContent = track.artist || '';
    renderPlaylist();

    // æ ‡è®°æ’­æ”¾å™¨å·²å‡†å¤‡å¥½
    window.musicPlayerReady = true;
  }

  // ä¿å­˜æ’­æ”¾çŠ¶æ€åˆ° localStorage
  function savePlayState() {
    if (playlist.length > 0 && audio.src) {
      localStorage.setItem('musicCurrentTrack', currentTrack);
      localStorage.setItem('musicCurrentTime', audio.currentTime || 0);
      localStorage.setItem('musicVolume', audio.volume);
      localStorage.setItem('musicWasPlaying', !audio.paused);
      localStorage.setItem('musicPlaylistLength', playlist.length);
    }
  }

  // å®šæœŸä¿å­˜æ’­æ”¾çŠ¶æ€ï¼ˆæ¯ç§’ä¸€æ¬¡ï¼Œæ›´é¢‘ç¹ï¼‰
  setInterval(savePlayState, 1000);

  // é¡µé¢å¸è½½å‰ä¿å­˜çŠ¶æ€
  window.addEventListener('beforeunload', savePlayState);

  // é¡µé¢éšè—æ—¶ä¿å­˜çŠ¶æ€ï¼ˆç§»åŠ¨ç«¯ï¼‰
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      savePlayState();
    }
  });

  // æ’­æ”¾/æš‚åœ
  playBtn.addEventListener('click', () => {
    if (audio.paused) {
      audio.play();
      playBtn.textContent = 'â¸';
      localStorage.setItem('musicWasPlaying', 'true');
    } else {
      audio.pause();
      playBtn.textContent = 'â–¶';
      localStorage.setItem('musicWasPlaying', 'false');
    }
  });

  // ä¸Šä¸€æ›²
  prevBtn.addEventListener('click', () => {
    if (playMode === 'single') {
      audio.currentTime = 0;
      audio.play();
    } else {
      currentTrack = (currentTrack - 1 + playlist.length) % playlist.length;
      loadTrack(currentTrack);
      audio.play();
    }
    playBtn.textContent = 'â¸';
    savePlayState();
  });

  // ä¸‹ä¸€æ›²
  nextBtn.addEventListener('click', () => {
    if (playMode === 'single') {
      audio.currentTime = 0;
      audio.play();
    } else {
      currentTrack = (currentTrack + 1) % playlist.length;
      loadTrack(currentTrack);
      audio.play();
    }
    playBtn.textContent = 'â¸';
    savePlayState();
  });

  // æ’­æ”¾æ¨¡å¼åˆ‡æ¢
  modeBtn.addEventListener('click', () => {
    const modes = ['order', 'random', 'single'];
    const currentIndex = modes.indexOf(playMode);
    playMode = modes[(currentIndex + 1) % modes.length];

    // æ›´æ–°æŒ‰é’®å›¾æ ‡
    const modeIcons = {
      'order': 'ğŸ”',   // é¡ºåºæ’­æ”¾
      'random': 'ğŸ”€',  // éšæœºæ’­æ”¾
      'single': 'ğŸ”‚'   // å•æ›²å¾ªç¯
    };
    modeBtn.textContent = modeIcons[playMode];

    const modeTitles = {
      'order': 'é¡ºåºæ’­æ”¾',
      'random': 'éšæœºæ’­æ”¾',
      'single': 'å•æ›²å¾ªç¯'
    };
    modeBtn.title = modeTitles[playMode];

    // å¦‚æœåˆ‡æ¢åˆ°éšæœºæ¨¡å¼ï¼Œç”Ÿæˆéšæœºç´¢å¼•
    if (playMode === 'random') {
      generateShuffledIndices();
      // ä¿æŒå½“å‰æ­Œæ›²ï¼Œè°ƒæ•´ currentTrack
      const currentActualIndex = getActualIndex(currentTrack);
      currentTrack = shuffledIndices.indexOf(currentActualIndex);
    } else if (playMode === 'order') {
      // ä»éšæœºæ¨¡å¼åˆ‡å›é¡ºåºæ¨¡å¼ï¼Œæ¢å¤å®é™…ç´¢å¼•
      currentTrack = getActualIndex(currentTrack);
    }

    renderPlaylist();
    localStorage.setItem('playMode', playMode);
  });

  // æ’­æ”¾åˆ—è¡¨æ˜¾ç¤º/éšè—
  playlistBtn.addEventListener('click', () => {
    playlistPanel.classList.toggle('show');
  });

  playlistClose.addEventListener('click', () => {
    playlistPanel.classList.remove('show');
  });

  // è‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€æ›²
  audio.addEventListener('ended', () => {
    if (playMode === 'single') {
      audio.currentTime = 0;
      audio.play();
    } else {
      nextBtn.click();
    }
  });

  // è¿›åº¦æ¡æ›´æ–°
  audio.addEventListener('timeupdate', () => {
    if (audio.duration) {
      const progress = (audio.currentTime / audio.duration) * 100;
      progressBar.value = progress;
      currentTimeEl.textContent = formatTime(audio.currentTime);
    }
  });

  // åŠ è½½å…ƒæ•°æ®æ—¶æ›´æ–°æ—¶é•¿
  audio.addEventListener('loadedmetadata', () => {
    durationEl.textContent = formatTime(audio.duration);
  });

  // è¿›åº¦æ¡æ‹–åŠ¨
  progressBar.addEventListener('input', (e) => {
    const time = (e.target.value / 100) * audio.duration;
    audio.currentTime = time;
  });

  // éŸ³é‡æ§åˆ¶
  volumeBar.addEventListener('input', (e) => {
    audio.volume = e.target.value / 100;
  });

  // è®¾ç½®åˆå§‹éŸ³é‡
  audio.volume = 0.3;

  // æ ¼å¼åŒ–æ—¶é—´
  function formatTime(seconds) {
    if (!seconds || isNaN(seconds)) return '0:00';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }

  // æŠ˜å /å±•å¼€æ’­æ”¾å™¨
  playerToggle.addEventListener('click', () => {
    playerContent.classList.toggle('collapsed');
    playerToggle.textContent = playerContent.classList.contains('collapsed') ? '+' : 'âˆ’';
  });

  // æ‹–åŠ¨åŠŸèƒ½
  const dragHandle = document.getElementById('player-drag-handle');
  let isDragging = false;
  let currentX;
  let currentY;
  let initialX;
  let initialY;
  let xOffset = 0;
  let yOffset = 0;

  // ä» localStorage æ¢å¤ä½ç½®
  const savedX = localStorage.getItem('playerX');
  const savedY = localStorage.getItem('playerY');
  if (savedX && savedY) {
    xOffset = parseInt(savedX);
    yOffset = parseInt(savedY);
    setTranslate(xOffset, yOffset, player);
  }

  dragHandle.addEventListener('mousedown', dragStart);
  document.addEventListener('mousemove', drag);
  document.addEventListener('mouseup', dragEnd);

  // è§¦æ‘¸äº‹ä»¶æ”¯æŒ
  dragHandle.addEventListener('touchstart', dragStart);
  document.addEventListener('touchmove', drag);
  document.addEventListener('touchend', dragEnd);

  function dragStart(e) {
    if (e.type === 'touchstart') {
      initialX = e.touches[0].clientX - xOffset;
      initialY = e.touches[0].clientY - yOffset;
    } else {
      initialX = e.clientX - xOffset;
      initialY = e.clientY - yOffset;
    }

    if (e.target === dragHandle || dragHandle.contains(e.target)) {
      isDragging = true;
    }
  }

  function drag(e) {
    if (isDragging) {
      e.preventDefault();

      if (e.type === 'touchmove') {
        currentX = e.touches[0].clientX - initialX;
        currentY = e.touches[0].clientY - initialY;
      } else {
        currentX = e.clientX - initialX;
        currentY = e.clientY - initialY;
      }

      xOffset = currentX;
      yOffset = currentY;

      setTranslate(currentX, currentY, player);
    }
  }

  function dragEnd(e) {
    if (isDragging) {
      initialX = currentX;
      initialY = currentY;
      isDragging = false;

      // ä¿å­˜ä½ç½®åˆ° localStorage
      localStorage.setItem('playerX', xOffset);
      localStorage.setItem('playerY', yOffset);
    }
  }

  function setTranslate(xPos, yPos, el) {
    el.style.transform = `translate3d(${xPos}px, ${yPos}px, 0)`;
  }

  // æŸ¥æ‰¾æŒ‡å®šæ­Œæ›²çš„ç´¢å¼•
  function findTrackByName(searchName) {
    for (let i = 0; i < playlist.length; i++) {
      if (playlist[i].url.includes(searchName) ||
          playlist[i].title.includes(searchName)) {
        return i;
      }
    }
    return 0; // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œè¿”å›ç¬¬ä¸€é¦–
  }

  // åˆå§‹åŒ–æ’­æ”¾å™¨
  function initializePlayer() {
    if (playlist.length > 0) {
      // æ¢å¤æ’­æ”¾æ¨¡å¼
      const savedMode = localStorage.getItem('playMode');
      if (savedMode && ['order', 'random', 'single'].includes(savedMode)) {
        playMode = savedMode;
      }

      // è®¾ç½®æ’­æ”¾æ¨¡å¼æŒ‰é’®å›¾æ ‡
      const modeIcons = {
        'order': 'ğŸ”',
        'random': 'ğŸ”€',
        'single': 'ğŸ”‚'
      };
      modeBtn.textContent = modeIcons[playMode];

      const modeTitles = {
        'order': 'é¡ºåºæ’­æ”¾',
        'random': 'éšæœºæ’­æ”¾',
        'single': 'å•æ›²å¾ªç¯'
      };
      modeBtn.title = modeTitles[playMode];

      // å¦‚æœæ˜¯éšæœºæ¨¡å¼ï¼Œç”Ÿæˆéšæœºç´¢å¼•
      if (playMode === 'random') {
        generateShuffledIndices();
      }

      // å°è¯•æ¢å¤ä¹‹å‰çš„æ’­æ”¾çŠ¶æ€
      const savedTrack = localStorage.getItem('musicCurrentTrack');
      const savedTime = localStorage.getItem('musicCurrentTime');
      const savedVolume = localStorage.getItem('musicVolume');
      const wasPlaying = localStorage.getItem('musicWasPlaying') === 'true';

      // æ¢å¤éŸ³é‡
      if (savedVolume) {
        audio.volume = parseFloat(savedVolume);
        volumeBar.value = audio.volume * 100;
      } else {
        audio.volume = 0.3;
        volumeBar.value = 30;
      }

      // æ¢å¤æ­Œæ›²å’Œæ’­æ”¾ä½ç½®
      const hasSavedState = savedTrack !== null && savedTrack !== undefined;

      if (hasSavedState && parseInt(savedTrack) < playlist.length) {
        const trackIndex = parseInt(savedTrack);
        loadTrack(trackIndex);

        // ä½¿ç”¨ Promise é“¾å¼å¤„ç†æ¢å¤é€»è¾‘
        let restoreAttempted = false;

        const restorePlayback = function() {
          if (restoreAttempted) return;
          restoreAttempted = true;

          // æ¢å¤æ’­æ”¾ä½ç½®
          if (savedTime && parseFloat(savedTime) > 0) {
            audio.currentTime = parseFloat(savedTime);
          }

          // å¦‚æœä¹‹å‰æ­£åœ¨æ’­æ”¾ï¼Œç»§ç»­æ’­æ”¾
          if (wasPlaying) {
            // ç«‹å³å°è¯•æ’­æ”¾ï¼Œä¸å»¶è¿Ÿ
            audio.play().then(() => {
              playBtn.textContent = 'â¸';
              console.log('âœ… æˆåŠŸæ¢å¤éŸ³ä¹æ’­æ”¾ -', playlist[getActualIndex(trackIndex)].title);
            }).catch(error => {
              console.log('âš ï¸ æ¢å¤æ’­æ”¾å¤±è´¥ï¼ˆå¯èƒ½éœ€è¦ç”¨æˆ·äº¤äº’ï¼‰:', error);
              playBtn.textContent = 'â–¶';
            });
          } else {
            playBtn.textContent = 'â–¶';
            console.log('âœ… æ¢å¤éŸ³ä¹çŠ¶æ€ï¼ˆæš‚åœä¸­ï¼‰-', playlist[getActualIndex(trackIndex)].title);
          }
        };

        // ç›‘å¬ canplay äº‹ä»¶ï¼Œè¿™æ˜¯æœ€å¯é çš„
        audio.addEventListener('canplay', restorePlayback, { once: true });

        // å¦‚æœéŸ³é¢‘å·²ç»å¯ä»¥æ’­æ”¾ï¼ˆç¼“å­˜ï¼‰ï¼Œç«‹å³æ¢å¤
        if (audio.readyState >= 3) {
          restorePlayback();
        }
      } else {
        // é¦–æ¬¡è®¿é—®æˆ–æ²¡æœ‰ä¿å­˜çŠ¶æ€ï¼ŒåŠ è½½æŒ‡å®šçš„é»˜è®¤æ­Œæ›²ï¼šçŸ³å·çœŸä¹Ÿ - ã‚ã®é ƒã®ã‚ˆã†ã«
        const defaultTrackIndex = findTrackByName('çŸ³å·çœŸä¹Ÿ - ã‚ã®é ƒã®ã‚ˆã†ã«');
        loadTrack(defaultTrackIndex);
        playBtn.textContent = 'â–¶';
        console.log('ğŸµ éŸ³ä¹æ’­æ”¾å™¨å·²å‡†å¤‡å°±ç»ªï¼Œé»˜è®¤æ­Œæ›²ï¼š' + playlist[defaultTrackIndex].title);

        // æ ‡è®°æ’­æ”¾å™¨å·²å‡†å¤‡å¥½ï¼Œä¾›å…¥å£å¤§é—¨ä½¿ç”¨
        window.musicPlayerReady = true;
      }
    } else {
      songTitle.textContent = 'æ’­æ”¾åˆ—è¡¨ä¸ºç©º';
      playBtn.disabled = true;
      prevBtn.disabled = true;
      nextBtn.disabled = true;
      modeBtn.disabled = true;
      playlistBtn.disabled = true;
    }
  }

  // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
  loadPlaylist();
})();
</script>
