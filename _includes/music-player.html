<!-- å¯æ‹–åŠ¨çš„éŸ³ä¹æ’­æ”¾å™¨ -->
<div id="music-player" class="music-player">
  <div class="player-header" id="player-drag-handle">
    <span class="player-title">ğŸµ éŸ³ä¹æ’­æ”¾å™¨</span>
    <button class="player-toggle" id="player-toggle">âˆ’</button>
  </div>
  <div class="player-content" id="player-content">
    <div class="player-info">
      <div class="song-title" id="song-title">æœªé€‰æ‹©éŸ³ä¹</div>
      <div class="song-artist" id="song-artist"></div>
    </div>
    <audio id="audio-player" preload="metadata"></audio>
    <div class="player-controls">
      <button class="control-btn" id="prev-btn">â®</button>
      <button class="control-btn play-btn" id="play-btn">â–¶</button>
      <button class="control-btn" id="next-btn">â­</button>
      <button class="control-btn" id="mode-btn" title="æ’­æ”¾æ¨¡å¼">ğŸ”</button>
      <button class="control-btn" id="playlist-btn" title="æ’­æ”¾åˆ—è¡¨">ğŸ“‹</button>
    </div>
    <div class="progress-container">
      <span class="time" id="current-time">0:00</span>
      <input type="range" class="progress-bar" id="progress-bar" min="0" max="100" value="0">
      <span class="time" id="duration">0:00</span>
    </div>
    <div class="volume-container">
      <span>ğŸ”Š</span>
      <input type="range" class="volume-bar" id="volume-bar" min="0" max="100" value="30">
    </div>
    <div class="playlist-panel" id="playlist-panel">
      <div class="playlist-header">
        <span>æ’­æ”¾åˆ—è¡¨</span>
        <button class="playlist-close" id="playlist-close">âœ•</button>
      </div>
      <div class="playlist-items" id="playlist-items">
        <!-- æ’­æ”¾åˆ—è¡¨é¡¹å°†åŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  /* æ’­æ”¾æ¨¡å¼: 'order' (é¡ºåº), 'random' (éšæœº), 'single' (å•æ›²å¾ªç¯) */
  var playMode = 'order';
  var playlist = [];
  var currentTrack = 0;
  var shuffledIndices = []; /* éšæœºæ’­æ”¾çš„ç´¢å¼•æ•°ç»„ */
  var defaultPlayOrder = []; /* é»˜è®¤æ’­æ”¾é¡ºåºï¼ˆé¦–æ¬¡è®¿é—®æ—¶éšæœºç”Ÿæˆï¼‰ */
  var player = document.getElementById('music-player');
  var audio = document.getElementById('audio-player');
  var playBtn = document.getElementById('play-btn');
  var prevBtn = document.getElementById('prev-btn');
  var nextBtn = document.getElementById('next-btn');
  var modeBtn = document.getElementById('mode-btn');
  var playlistBtn = document.getElementById('playlist-btn');
  var progressBar = document.getElementById('progress-bar');
  var volumeBar = document.getElementById('volume-bar');
  var currentTimeEl = document.getElementById('current-time');
  var durationEl = document.getElementById('duration');
  var songTitle = document.getElementById('song-title');
  var songArtist = document.getElementById('song-artist');
  var playerToggle = document.getElementById('player-toggle');
  var playerContent = document.getElementById('player-content');
  var playlistPanel = document.getElementById('playlist-panel');
  var playlistItems = document.getElementById('playlist-items');
  var playlistClose = document.getElementById('playlist-close');

  /* ä»æ–‡ä»¶è·¯å¾„æå–æ­Œæ›²ä¿¡æ¯ */
  function extractSongInfo(path) {
    /* è·å–æ–‡ä»¶åï¼ˆä¸å«è·¯å¾„å’Œæ‰©å±•åï¼‰ */
    var filename = path.split('/').pop().replace(/\.[^/.]+$/, '');

    /* å°è¯•è§£æ "è‰ºæœ¯å®¶ - æ­Œæ›²å" æ ¼å¼ */
    var title = filename;
    var artist = '';

    if (filename.includes(' - ')) {
      var parts = filename.split(' - ');
      artist = parts[0].trim();
      title = parts.slice(1).join(' - ').trim();
    }

    /* æ¸…ç†ç‰¹æ®Šå­—ç¬¦ï¼ˆå¦‚ ï¼»602ï½ï¼½ æˆ– [xxx]ï¼‰ */
    title = title.replace(/ï¼»[^\ï¼½]*ï¼½/g, '').replace(/\[[^\]]*\]/g, '').trim();
    artist = artist.replace(/ï¼»[^\ï¼½]*ï¼½/g, '').replace(/\[[^\]]*\]/g, '').trim();

    return { title: title || 'æœªçŸ¥æ­Œæ›²', artist: artist };
  }

  /* ä½¿ç”¨ Jekyll è‡ªåŠ¨æ‰«æ audio ç›®å½•ä¸‹çš„éŸ³é¢‘æ–‡ä»¶ */
  {% assign audio_files = site.static_files | where_exp: "file", "file.path contains '/audio/'" %}
  var audioFiles = [
    {% for file in audio_files %}
      {% assign ext = file.extname | downcase %}
      {% if ext == '.mp3' or ext == '.wav' or ext == '.ogg' or ext == '.m4a' or ext == '.flac' or ext == '.aac' %}
    "{{ file.path }}"{% unless forloop.last %},{% endunless %}
      {% endif %}
    {% endfor %}
  ];

  /* åŠ è½½æ’­æ”¾åˆ—è¡¨ */
  function loadPlaylist() {
    /* å°†æ–‡ä»¶è·¯å¾„è½¬æ¢ä¸ºæ’­æ”¾åˆ—è¡¨æ ¼å¼ */
    playlist = audioFiles.map(function(path) {
      var info = extractSongInfo(path);
      return {
        title: info.title,
        artist: info.artist,
        url: path
      };
    });

    if (playlist.length === 0) {
      songTitle.textContent = 'audio ç›®å½•ä¸‹æ²¡æœ‰éŸ³ä¹æ–‡ä»¶';
      playBtn.disabled = true;
      prevBtn.disabled = true;
      nextBtn.disabled = true;
      modeBtn.disabled = true;
      playlistBtn.disabled = true;
    } else {
      /* ç”Ÿæˆæˆ–æ¢å¤é»˜è®¤æ’­æ”¾é¡ºåº */
      var savedOrder = localStorage.getItem('defaultPlayOrder');
      if (savedOrder) {
        /* æ¢å¤ä¿å­˜çš„æ’­æ”¾é¡ºåº */
        try {
          defaultPlayOrder = JSON.parse(savedOrder);
          /* éªŒè¯æ’­æ”¾é¡ºåºæ˜¯å¦æœ‰æ•ˆ */
          if (!Array.isArray(defaultPlayOrder) || defaultPlayOrder.length !== playlist.length) {
            /* æ— æ•ˆï¼Œé‡æ–°ç”Ÿæˆ */
            generateDefaultPlayOrder();
          }
        } catch (e) {
          /* è§£æå¤±è´¥ï¼Œé‡æ–°ç”Ÿæˆ */
          generateDefaultPlayOrder();
        }
      } else {
        /* é¦–æ¬¡è®¿é—®ï¼Œç”Ÿæˆéšæœºæ’­æ”¾é¡ºåº */
        generateDefaultPlayOrder();
      }

      initializePlayer();
    }
  }

  /* ç”Ÿæˆé»˜è®¤æ’­æ”¾é¡ºåºï¼šç¡®ä¿"ã‚ã®é ƒã®ã‚ˆã†ã«"åœ¨ç¬¬ä¸€ä½ï¼Œå…¶ä»–éšæœº */
  function generateDefaultPlayOrder() {
    /* æ‰¾åˆ°"ã‚ã®é ƒã®ã‚ˆã†ã«"çš„ç´¢å¼• */
    var defaultTrackIndex = -1;
    for (var i = 0; i < playlist.length; i++) {
      if (playlist[i].url.includes('çŸ³å·çœŸä¹Ÿ - ã‚ã®é ƒã®ã‚ˆã†ã«') ||
          playlist[i].title.includes('ã‚ã®é ƒã®ã‚ˆã†ã«')) {
        defaultTrackIndex = i;
        break;
      }
    }

    /* ç”Ÿæˆç´¢å¼•æ•°ç»„ [0, 1, 2, ...] */
    defaultPlayOrder = Array.from({ length: playlist.length }, function(_, i) { return i; });

    /* å¦‚æœæ‰¾åˆ°äº†"ã‚ã®é ƒã®ã‚ˆã†ã«" */
    if (defaultTrackIndex >= 0) {
      /* ç§»é™¤è¿™é¦–æ­Œçš„ç´¢å¼• */
      defaultPlayOrder.splice(defaultTrackIndex, 1);

      /* éšæœºæ‰“ä¹±å‰©ä½™ç´¢å¼• */
      for (var i = defaultPlayOrder.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = defaultPlayOrder[i];
        defaultPlayOrder[i] = defaultPlayOrder[j];
        defaultPlayOrder[j] = temp;
      }

      /* å°†"ã‚ã®é ƒã®ã‚ˆã†ã«"çš„ç´¢å¼•æ”¾åœ¨ç¬¬ä¸€ä½ */
      defaultPlayOrder.unshift(defaultTrackIndex);
    } else {
      /* å¦‚æœæ²¡æ‰¾åˆ°ï¼Œåªæ˜¯éšæœºæ‰“ä¹±æ‰€æœ‰ç´¢å¼• */
      for (var i = defaultPlayOrder.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = defaultPlayOrder[i];
        defaultPlayOrder[i] = defaultPlayOrder[j];
        defaultPlayOrder[j] = temp;
      }
    }

    /* ä¿å­˜åˆ° localStorage */
    localStorage.setItem('defaultPlayOrder', JSON.stringify(defaultPlayOrder));
  }

  /* ç”Ÿæˆéšæœºæ’­æ”¾ç´¢å¼• */
  function generateShuffledIndices() {
    shuffledIndices = Array.from({ length: playlist.length }, function(_, i) { return i; });
    for (var i = shuffledIndices.length - 1; i > 0; i--) {
      var j = Math.floor(Math.random() * (i + 1));
      var temp = shuffledIndices[i];
      shuffledIndices[i] = shuffledIndices[j];
      shuffledIndices[j] = temp;
    }
  }

  /* è·å–å®é™…æ’­æ”¾ç´¢å¼•ï¼ˆè€ƒè™‘æ’­æ”¾æ¨¡å¼ï¼‰ */
  function getActualIndex(displayIndex) {
    if (playMode === 'random') {
      return shuffledIndices[displayIndex];
    } else if (playMode === 'order' && defaultPlayOrder.length > 0) {
      /* é¡ºåºæ’­æ”¾æ¨¡å¼ä½¿ç”¨é»˜è®¤æ’­æ”¾é¡ºåº */
      return defaultPlayOrder[displayIndex];
    }
    return displayIndex;
  }

  /* æ¸²æŸ“æ’­æ”¾åˆ—è¡¨ */
  function renderPlaylist() {
    playlistItems.innerHTML = '';

    /* æ ¹æ®æ’­æ”¾æ¨¡å¼å†³å®šæ˜¾ç¤ºé¡ºåº */
    var displayOrder;
    if (playMode === 'random' && shuffledIndices.length > 0) {
      displayOrder = shuffledIndices;
    } else if (playMode === 'order' && defaultPlayOrder.length > 0) {
      displayOrder = defaultPlayOrder;
    } else {
      displayOrder = Array.from({ length: playlist.length }, function(_, i) { return i; });
    }

    displayOrder.forEach(function(actualIndex, displayIndex) {
      var track = playlist[actualIndex];
      var item = document.createElement('div');
      item.className = 'playlist-item';

      /* åˆ¤æ–­æ˜¯å¦æ˜¯å½“å‰æ’­æ”¾çš„æ­Œæ›² */
      if (getActualIndex(currentTrack) === actualIndex) {
        item.classList.add('active');
      }

      item.innerHTML = '<div class="playlist-item-title">' + track.title + '</div><div class="playlist-item-artist">' + (track.artist || '') + '</div>';

      item.addEventListener('click', function() {
        /* ç‚¹å‡»æ’­æ”¾åˆ—è¡¨é¡¹æ—¶ï¼Œè®¾ç½® currentTrack ä¸ºæ˜¾ç¤ºç´¢å¼• */
        currentTrack = displayIndex;
        loadTrack(currentTrack);
        audio.play();
        playBtn.textContent = 'â¸';
        renderPlaylist();
        savePlayState();
      });

      playlistItems.appendChild(item);
    });
  }

  /* åŠ è½½æ­Œæ›² */
  var loadRetryCount = 0;
  var maxLoadRetries = 3;

  function loadTrack(index) {
    if (playlist.length === 0) return;
    currentTrack = index;
    var actualIndex = getActualIndex(currentTrack);
    var track = playlist[actualIndex];
    /* å¯¹ URL è¿›è¡Œç¼–ç ï¼Œå¤„ç†ç‰¹æ®Šå­—ç¬¦ï¼ˆåŒç©ºæ ¼ã€ä¸­æ–‡ã€æ‹¬å·ç­‰ï¼‰ */
    audio.src = encodeURI(track.url);
    songTitle.textContent = track.title;
    songArtist.textContent = track.artist || '';
    loadRetryCount = 0; /* é‡ç½®é‡è¯•è®¡æ•° */
    renderPlaylist();

    /* æ ‡è®°æ’­æ”¾å™¨å·²å‡†å¤‡å¥½ */
    window.musicPlayerReady = true;
  }

  /* éŸ³é¢‘åŠ è½½é”™è¯¯å¤„ç† */
  audio.addEventListener('error', function(e) {
    var error = audio.error;
    var errorMessages = {
      1: 'åŠ è½½è¢«ä¸­æ­¢',
      2: 'ç½‘ç»œé”™è¯¯',
      3: 'è§£ç å¤±è´¥',
      4: 'ä¸æ”¯æŒçš„æ ¼å¼'
    };
    var errorCode = error ? error.code : 0;
    var errorMsg = errorMessages[errorCode] || 'æœªçŸ¥é”™è¯¯';

    console.log('âš ï¸ éŸ³é¢‘åŠ è½½å¤±è´¥: ' + errorMsg + ' (' + playlist[getActualIndex(currentTrack)].title + ')');

    /* é‡è¯•åŠ è½½ */
    if (loadRetryCount < maxLoadRetries) {
      loadRetryCount++;
      console.log('ğŸ”„ å°è¯•é‡æ–°åŠ è½½... (' + loadRetryCount + '/' + maxLoadRetries + ')');
      setTimeout(function() {
        var track = playlist[getActualIndex(currentTrack)];
        /* æ·»åŠ æ—¶é—´æˆ³ç»•è¿‡ç¼“å­˜ï¼Œå¹¶å¯¹ URL è¿›è¡Œç¼–ç  */
        audio.src = encodeURI(track.url) + '?t=' + Date.now();
      }, 1000 * loadRetryCount); /* é€’å¢å»¶è¿Ÿ */
    } else {
      /* é‡è¯•å¤±è´¥ï¼Œå°è¯•æ’­æ”¾ä¸‹ä¸€é¦– */
      console.log('âŒ åŠ è½½å¤±è´¥ï¼Œè·³è¿‡æ­¤æ›²');
      songTitle.textContent = 'åŠ è½½å¤±è´¥: ' + errorMsg;
      setTimeout(function() {
        if (playlist.length > 1) {
          currentTrack = (currentTrack + 1) % playlist.length;
          loadTrack(currentTrack);
        }
      }, 2000);
    }
  });

  /* ç½‘ç»œä¸­æ–­æ—¶çš„å¤„ç† */
  audio.addEventListener('stalled', function() {
    console.log('âš ï¸ éŸ³é¢‘åŠ è½½åœæ»ï¼Œå¯èƒ½ç½‘ç»œä¸ç¨³å®š');
  });

  audio.addEventListener('waiting', function() {
    console.log('â³ æ­£åœ¨ç¼“å†²...');
  });

  /* ä¿å­˜æ’­æ”¾çŠ¶æ€åˆ° localStorage */
  function savePlayState() {
    if (playlist.length > 0 && audio.src) {
      localStorage.setItem('musicCurrentTrack', currentTrack);
      localStorage.setItem('musicCurrentTime', audio.currentTime || 0);
      localStorage.setItem('musicVolume', audio.volume);
      localStorage.setItem('musicWasPlaying', !audio.paused);
      localStorage.setItem('musicPlaylistLength', playlist.length);
    }
  }

  /* å®šæœŸä¿å­˜æ’­æ”¾çŠ¶æ€ï¼ˆæ¯ç§’ä¸€æ¬¡ï¼Œæ›´é¢‘ç¹ï¼‰ */
  setInterval(savePlayState, 1000);

  /* é¡µé¢å¸è½½å‰ä¿å­˜çŠ¶æ€ */
  window.addEventListener('beforeunload', savePlayState);

  /* é¡µé¢éšè—æ—¶ä¿å­˜çŠ¶æ€ï¼ˆç§»åŠ¨ç«¯ï¼‰ */
  document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
      savePlayState();
    }
  });

  /* æ’­æ”¾/æš‚åœ */
  playBtn.addEventListener('click', function() {
    if (audio.paused) {
      audio.play();
      playBtn.textContent = 'â¸';
      localStorage.setItem('musicWasPlaying', 'true');
    } else {
      audio.pause();
      playBtn.textContent = 'â–¶';
      localStorage.setItem('musicWasPlaying', 'false');
    }
  });

  /* ä¸Šä¸€æ›² */
  prevBtn.addEventListener('click', function() {
    /* å•æ›²å¾ªç¯æ¨¡å¼ä¸‹ï¼Œæ‰‹åŠ¨ç‚¹å‡»ä¹Ÿå¯ä»¥åˆ‡æ¢åˆ°ä¸Šä¸€æ›² */
    currentTrack = (currentTrack - 1 + playlist.length) % playlist.length;
    loadTrack(currentTrack);
    audio.play();
    playBtn.textContent = 'â¸';
    savePlayState();
  });

  /* ä¸‹ä¸€æ›² */
  nextBtn.addEventListener('click', function() {
    /* å•æ›²å¾ªç¯æ¨¡å¼ä¸‹ï¼Œæ‰‹åŠ¨ç‚¹å‡»ä¹Ÿå¯ä»¥åˆ‡æ¢åˆ°ä¸‹ä¸€æ›² */
    currentTrack = (currentTrack + 1) % playlist.length;
    loadTrack(currentTrack);
    audio.play();
    playBtn.textContent = 'â¸';
    savePlayState();
  });

  /* æ’­æ”¾æ¨¡å¼åˆ‡æ¢ */
  modeBtn.addEventListener('click', function() {
    var modes = ['order', 'random', 'single'];
    var currentModeIndex = modes.indexOf(playMode);
    var oldMode = playMode;
    playMode = modes[(currentModeIndex + 1) % modes.length];

    /* æ›´æ–°æŒ‰é’®å›¾æ ‡ */
    var modeIcons = {
      'order': 'ğŸ”',   /* é¡ºåºæ’­æ”¾ */
      'random': 'ğŸ”€',  /* éšæœºæ’­æ”¾ */
      'single': 'ğŸ”‚'   /* å•æ›²å¾ªç¯ */
    };
    modeBtn.textContent = modeIcons[playMode];

    var modeTitles = {
      'order': 'é¡ºåºæ’­æ”¾',
      'random': 'éšæœºæ’­æ”¾',
      'single': 'å•æ›²å¾ªç¯'
    };
    modeBtn.title = modeTitles[playMode];

    /* æ ¹æ®æ¨¡å¼åˆ‡æ¢è°ƒæ•´ currentTrackï¼Œä¿æŒå½“å‰æ’­æ”¾çš„æ­Œæ›²ä¸å˜ */
    var currentActualIndex = getActualIndex(currentTrack);

    if (playMode === 'random') {
      /* åˆ‡æ¢åˆ°éšæœºæ¨¡å¼ */
      generateShuffledIndices();
      /* æ‰¾åˆ°å½“å‰æ­Œæ›²åœ¨æ–°çš„éšæœºç´¢å¼•ä¸­çš„ä½ç½® */
      currentTrack = shuffledIndices.indexOf(currentActualIndex);
    } else if (playMode === 'order') {
      /* åˆ‡æ¢åˆ°é¡ºåºæ¨¡å¼ */
      /* æ‰¾åˆ°å½“å‰æ­Œæ›²åœ¨ defaultPlayOrder ä¸­çš„ä½ç½® */
      currentTrack = defaultPlayOrder.indexOf(currentActualIndex);
      if (currentTrack === -1) {
        currentTrack = 0; /* å¦‚æœæ‰¾ä¸åˆ°ï¼Œé»˜è®¤ç¬¬ä¸€é¦– */
      }
    } else if (playMode === 'single') {
      /* åˆ‡æ¢åˆ°å•æ›²å¾ªç¯æ¨¡å¼ï¼Œä¿æŒ currentTrack ä¸å˜å³å¯ */
      if (oldMode === 'random') {
        /* ä»éšæœºæ¨¡å¼åˆ‡æ¢ï¼Œéœ€è¦æ‰¾åˆ°åœ¨ defaultPlayOrder ä¸­çš„ä½ç½® */
        currentTrack = defaultPlayOrder.indexOf(currentActualIndex);
        if (currentTrack === -1) {
          currentTrack = 0;
        }
      }
    }

    renderPlaylist();
    localStorage.setItem('playMode', playMode);
  });

  /* æ’­æ”¾åˆ—è¡¨æ˜¾ç¤º/éšè— */
  playlistBtn.addEventListener('click', function() {
    playlistPanel.classList.toggle('show');
  });

  playlistClose.addEventListener('click', function() {
    playlistPanel.classList.remove('show');
  });

  /* è‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€æ›² */
  audio.addEventListener('ended', function() {
    if (playMode === 'single') {
      audio.currentTime = 0;
      audio.play();
    } else {
      nextBtn.click();
    }
  });

  /* è¿›åº¦æ¡æ›´æ–° */
  audio.addEventListener('timeupdate', function() {
    if (audio.duration) {
      var progress = (audio.currentTime / audio.duration) * 100;
      progressBar.value = progress;
      currentTimeEl.textContent = formatTime(audio.currentTime);
    }
  });

  /* åŠ è½½å…ƒæ•°æ®æ—¶æ›´æ–°æ—¶é•¿ */
  audio.addEventListener('loadedmetadata', function() {
    durationEl.textContent = formatTime(audio.duration);
  });

  /* è¿›åº¦æ¡æ‹–åŠ¨ */
  progressBar.addEventListener('input', function(e) {
    var time = (e.target.value / 100) * audio.duration;
    audio.currentTime = time;
  });

  /* éŸ³é‡æ§åˆ¶ */
  volumeBar.addEventListener('input', function(e) {
    audio.volume = e.target.value / 100;
  });

  /* è®¾ç½®åˆå§‹éŸ³é‡ */
  audio.volume = 0.3;

  /* æ ¼å¼åŒ–æ—¶é—´ */
  function formatTime(seconds) {
    if (!seconds || isNaN(seconds)) return '0:00';
    var mins = Math.floor(seconds / 60);
    var secs = Math.floor(seconds % 60);
    return mins + ':' + (secs < 10 ? '0' : '') + secs;
  }

  /* æŠ˜å /å±•å¼€æ’­æ”¾å™¨ */
  playerToggle.addEventListener('click', function() {
    playerContent.classList.toggle('collapsed');
    playerToggle.textContent = playerContent.classList.contains('collapsed') ? '+' : 'âˆ’';
  });

  /* æ‹–åŠ¨åŠŸèƒ½ */
  var dragHandle = document.getElementById('player-drag-handle');
  var isDragging = false;
  var currentX;
  var currentY;
  var initialX;
  var initialY;
  var xOffset = 0;
  var yOffset = 0;

  /* ä» localStorage æ¢å¤ä½ç½® */
  var savedX = localStorage.getItem('playerX');
  var savedY = localStorage.getItem('playerY');
  if (savedX && savedY) {
    xOffset = parseInt(savedX);
    yOffset = parseInt(savedY);
    setTranslate(xOffset, yOffset, player);
  }

  dragHandle.addEventListener('mousedown', dragStart);
  document.addEventListener('mousemove', drag);
  document.addEventListener('mouseup', dragEnd);

  /* è§¦æ‘¸äº‹ä»¶æ”¯æŒ */
  dragHandle.addEventListener('touchstart', dragStart);
  document.addEventListener('touchmove', drag);
  document.addEventListener('touchend', dragEnd);

  function dragStart(e) {
    if (e.type === 'touchstart') {
      initialX = e.touches[0].clientX - xOffset;
      initialY = e.touches[0].clientY - yOffset;
    } else {
      initialX = e.clientX - xOffset;
      initialY = e.clientY - yOffset;
    }

    if (e.target === dragHandle || dragHandle.contains(e.target)) {
      isDragging = true;
    }
  }

  function drag(e) {
    if (isDragging) {
      e.preventDefault();

      if (e.type === 'touchmove') {
        currentX = e.touches[0].clientX - initialX;
        currentY = e.touches[0].clientY - initialY;
      } else {
        currentX = e.clientX - initialX;
        currentY = e.clientY - initialY;
      }

      xOffset = currentX;
      yOffset = currentY;

      setTranslate(currentX, currentY, player);
    }
  }

  function dragEnd(e) {
    if (isDragging) {
      initialX = currentX;
      initialY = currentY;
      isDragging = false;

      /* ä¿å­˜ä½ç½®åˆ° localStorage */
      localStorage.setItem('playerX', xOffset);
      localStorage.setItem('playerY', yOffset);
    }
  }

  function setTranslate(xPos, yPos, el) {
    el.style.transform = 'translate3d(' + xPos + 'px, ' + yPos + 'px, 0)';
  }

  /* æŸ¥æ‰¾æŒ‡å®šæ­Œæ›²çš„ç´¢å¼• */
  function findTrackByName(searchName) {
    for (var i = 0; i < playlist.length; i++) {
      if (playlist[i].url.includes(searchName) ||
          playlist[i].title.includes(searchName)) {
        return i;
      }
    }
    return 0; /* å¦‚æœæ²¡æ‰¾åˆ°ï¼Œè¿”å›ç¬¬ä¸€é¦– */
  }

  /* åˆå§‹åŒ–æ’­æ”¾å™¨ */
  function initializePlayer() {
    if (playlist.length > 0) {
      /* æ¢å¤æ’­æ”¾æ¨¡å¼ */
      var savedMode = localStorage.getItem('playMode');
      if (savedMode && ['order', 'random', 'single'].includes(savedMode)) {
        playMode = savedMode;
      }

      /* è®¾ç½®æ’­æ”¾æ¨¡å¼æŒ‰é’®å›¾æ ‡ */
      var modeIcons = {
        'order': 'ğŸ”',
        'random': 'ğŸ”€',
        'single': 'ğŸ”‚'
      };
      modeBtn.textContent = modeIcons[playMode];

      var modeTitles = {
        'order': 'é¡ºåºæ’­æ”¾',
        'random': 'éšæœºæ’­æ”¾',
        'single': 'å•æ›²å¾ªç¯'
      };
      modeBtn.title = modeTitles[playMode];

      /* å¦‚æœæ˜¯éšæœºæ¨¡å¼ï¼Œç”Ÿæˆéšæœºç´¢å¼• */
      if (playMode === 'random') {
        generateShuffledIndices();
      }

      /* å°è¯•æ¢å¤ä¹‹å‰çš„æ’­æ”¾çŠ¶æ€ */
      var savedTrack = localStorage.getItem('musicCurrentTrack');
      var savedTime = localStorage.getItem('musicCurrentTime');
      var savedVolume = localStorage.getItem('musicVolume');
      var wasPlaying = localStorage.getItem('musicWasPlaying') === 'true';

      /* æ¢å¤éŸ³é‡ */
      if (savedVolume) {
        audio.volume = parseFloat(savedVolume);
        volumeBar.value = audio.volume * 100;
      } else {
        audio.volume = 0.3;
        volumeBar.value = 30;
      }

      /* æ¢å¤æ­Œæ›²å’Œæ’­æ”¾ä½ç½® */
      var hasSavedState = savedTrack !== null && savedTrack !== undefined;

      if (hasSavedState && parseInt(savedTrack) < playlist.length) {
        var trackIndex = parseInt(savedTrack);
        loadTrack(trackIndex);

        /* ä½¿ç”¨ Promise é“¾å¼å¤„ç†æ¢å¤é€»è¾‘ */
        var restoreAttempted = false;

        var restorePlayback = function() {
          if (restoreAttempted) return;
          restoreAttempted = true;

          /* æ¢å¤æ’­æ”¾ä½ç½® */
          if (savedTime && parseFloat(savedTime) > 0) {
            audio.currentTime = parseFloat(savedTime);
          }

          /* å¦‚æœä¹‹å‰æ­£åœ¨æ’­æ”¾ï¼Œç»§ç»­æ’­æ”¾ */
          if (wasPlaying) {
            /* ç«‹å³å°è¯•æ’­æ”¾ï¼Œä¸å»¶è¿Ÿ */
            audio.play().then(function() {
              playBtn.textContent = 'â¸';
              console.log('âœ… æˆåŠŸæ¢å¤éŸ³ä¹æ’­æ”¾ -', playlist[getActualIndex(trackIndex)].title);
            }).catch(function(error) {
              console.log('âš ï¸ æ¢å¤æ’­æ”¾å¤±è´¥ï¼ˆå¯èƒ½éœ€è¦ç”¨æˆ·äº¤äº’ï¼‰:', error);
              playBtn.textContent = 'â–¶';
            });
          } else {
            playBtn.textContent = 'â–¶';
            console.log('âœ… æ¢å¤éŸ³ä¹çŠ¶æ€ï¼ˆæš‚åœä¸­ï¼‰-', playlist[getActualIndex(trackIndex)].title);
          }
        };

        /* ç›‘å¬ canplay äº‹ä»¶ï¼Œè¿™æ˜¯æœ€å¯é çš„ */
        audio.addEventListener('canplay', restorePlayback, { once: true });

        /* å¦‚æœéŸ³é¢‘å·²ç»å¯ä»¥æ’­æ”¾ï¼ˆç¼“å­˜ï¼‰ï¼Œç«‹å³æ¢å¤ */
        if (audio.readyState >= 3) {
          restorePlayback();
        }
      } else {
        /* é¦–æ¬¡è®¿é—®æˆ–æ²¡æœ‰ä¿å­˜çŠ¶æ€ï¼ŒåŠ è½½é»˜è®¤æ’­æ”¾åˆ—è¡¨çš„ç¬¬ä¸€é¦–æ­Œï¼ˆã‚ã®é ƒã®ã‚ˆã†ã«ï¼‰ */
        currentTrack = 0;
        loadTrack(currentTrack);
        playBtn.textContent = 'â–¶';
        var actualIndex = getActualIndex(currentTrack);
        console.log('ğŸµ éŸ³ä¹æ’­æ”¾å™¨å·²å‡†å¤‡å°±ç»ªï¼Œé»˜è®¤æ­Œæ›²ï¼š' + playlist[actualIndex].title);

        /* æ ‡è®°æ’­æ”¾å™¨å·²å‡†å¤‡å¥½ï¼Œä¾›å…¥å£å¤§é—¨ä½¿ç”¨ */
        window.musicPlayerReady = true;
      }
    } else {
      songTitle.textContent = 'æ’­æ”¾åˆ—è¡¨ä¸ºç©º';
      playBtn.disabled = true;
      prevBtn.disabled = true;
      nextBtn.disabled = true;
      modeBtn.disabled = true;
      playlistBtn.disabled = true;
    }
  }

  /* é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ– */
  loadPlaylist();
})();
</script>
