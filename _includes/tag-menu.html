{% include base_path %}

{% comment %}
  收集所有标签及其使用次数
{% endcomment %}
{% assign tag_data = "" | split: "" %}
{% for post in site.posts %}
  {% for tag in post.tags %}
    {% assign found = false %}
    {% for item in tag_data %}
      {% assign parts = item | split: "|" %}
      {% if parts[0] == tag %}
        {% assign found = true %}
      {% endif %}
    {% endfor %}
    {% unless found %}
      {% assign tag_count = 0 %}
      {% for p in site.posts %}
        {% if p.tags contains tag %}
          {% assign tag_count = tag_count | plus: 1 %}
        {% endif %}
      {% endfor %}
      {% comment %} 过滤掉名称超过8个字符的标签（防止超出一行） {% endcomment %}
      {% assign tag_length = tag | size %}
      {% if tag_length <= 8 %}
        {% assign tag_item = tag | append: "|" | append: tag_count %}
        {% assign tag_data = tag_data | push: tag_item %}
      {% endif %}
    {% endunless %}
  {% endfor %}
{% endfor %}

{% comment %}
  按使用次数排序（降序）- 使用 Liquid 排序
{% endcomment %}
{% assign sorted_tags = tag_data | sort %}
{% assign final_tags = "" | split: "" %}
{% for i in (1..100) %}
  {% assign max_count = 0 %}
  {% assign max_tag = nil %}
  {% assign max_index = -1 %}
  {% for item in sorted_tags %}
    {% assign parts = item | split: "|" %}
    {% assign count = parts[1] | plus: 0 %}
    {% if count > max_count %}
      {% assign max_count = count %}
      {% assign max_tag = item %}
      {% assign max_index = forloop.index0 %}
    {% endif %}
  {% endfor %}
  {% if max_tag %}
    {% assign final_tags = final_tags | push: max_tag %}
    {% assign new_sorted = "" | split: "" %}
    {% for item in sorted_tags %}
      {% unless item == max_tag %}
        {% assign new_sorted = new_sorted | push: item %}
      {% endunless %}
    {% endfor %}
    {% assign sorted_tags = new_sorted %}
  {% endif %}
  {% if sorted_tags.size == 0 %}
    {% break %}
  {% endif %}
{% endfor %}

{% if final_tags.size > 0 %}
<div class="tag-menu">
  <h4 class="tag-menu__title">
    <i class="fa fa-tags" aria-hidden="true"></i> 标签
  </h4>
  <div class="tag-menu__list">
    {% for item in final_tags %}
      {% assign parts = item | split: "|" %}
      {% assign tag_name = parts[0] %}
      {% assign tag_count = parts[1] %}
      <a href="{{ base_path }}/tags/#{{ tag_name | slugify }}" class="tag-menu__item">
        <span class="tag-menu__name">{{ tag_name }}</span>
        <span class="tag-menu__count">{{ tag_count }}</span>
      </a>
    {% endfor %}
  </div>
</div>
{% endif %}
